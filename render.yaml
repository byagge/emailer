services:
  - type: web
    name: emailer
    env: python

    # Переменные окружения
    envVars:
      - key: DJANGO_SETTINGS_MODULE
        value: core.settings.dev    # подтянет SECRET_KEY из core/settings/dev.py
      # DATABASE_URL не нужен — Django по-умолчанию будет использовать sqlite3

    # Сборка: устанавливаем зависимости
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt

    # Запуск: миграции, создание суперпользователя (если отсутствует) и Gunicorn
    startCommand: |
      bash -lc "\
        python manage.py migrate --no-input && \
        python manage.py shell -c \"\
from django.contrib.auth import get_user_model; \
User = get_user_model(); \
if not User.objects.filter(username='admin').exists(): \
    User.objects.create_superuser('admin','admin@example.com','admin123')\" && \
        gunicorn core.wsgi:application --bind 0.0.0.0:\$PORT"
